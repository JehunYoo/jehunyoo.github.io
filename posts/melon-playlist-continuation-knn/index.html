<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Melon Playlist Continuation - Model 2: K Nearest Neighbor" /><meta property="og:locale" content="en" /><meta name="description" content="Reference" /><meta property="og:description" content="Reference" /><link rel="canonical" href="https://jehunyoo.github.io/posts/melon-playlist-continuation-knn/" /><meta property="og:url" content="https://jehunyoo.github.io/posts/melon-playlist-continuation-knn/" /><meta property="og:site_name" content="jehunyoo.github.io" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-26T19:24:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Melon Playlist Continuation - Model 2: K Nearest Neighbor" /><meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-07-26T19:24:00+09:00","datePublished":"2020-07-26T19:24:00+09:00","description":"Reference","headline":"Melon Playlist Continuation - Model 2: K Nearest Neighbor","mainEntityOfPage":{"@type":"WebPage","@id":"https://jehunyoo.github.io/posts/melon-playlist-continuation-knn/"},"url":"https://jehunyoo.github.io/posts/melon-playlist-continuation-knn/"}</script><title>Melon Playlist Continuation - Model 2: K Nearest Neighbor | jehunyoo.github.io</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="jehunyoo.github.io"><meta name="application-name" content="jehunyoo.github.io"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">jehunyoo.github.io</a></div><div class="site-subtitle font-italic">developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/JehunYoo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/jehunyoo/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Melon Playlist Continuation - Model 2: K Nearest Neighbor</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Melon Playlist Continuation - Model 2: K Nearest Neighbor</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1595759040" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 26, 2020 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/jehunyoo">Jehun Yoo</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1832 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://eprints.sztaki.hu/9560/1/Kelen_1_30347064_ny.pdf">[Paper]</a> <a href="https://github.com/proto-n/recsys-challenge-2018">[Code]</a> Efficient K-NN for Playlist Continuation (RecSys’18 Challenge)</p><p>위의 논문을 바탕으로 KNN 모델을 만들었다.</p><h2 id="process"><span class="mr-2">Process</span><a href="#process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="1-notaion"><span class="mr-2">1. Notaion</span><a href="#1-notaion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>$\mathcal{P}$ : All Playlists in train.json<li>$\mathcal{T}$ : All Tracks<li>$u$ : Target Playlist in val.json or test.json<li>$v$ : Candidate Playlist in train.json<li>Known Track $j \in u$<li>Candidate Track $i \in v$<li>$s_{uv}$ : Similarity between Target Playlist $u$ and Candidate Playlist $v$<li>$r_{ui}$ : Relevance between Candidate Track $i$ and Target Playlist $u$<li>$k$, $\rho$ : Hyperparameter</ul><h3 id="2-similarity-s_uv"><span class="mr-2">2. Similarity $s_{uv}$</span><a href="#2-similarity-s_uv" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="21-cosine-similarity"><span class="mr-2">2.1 Cosine Similarity</span><a href="#21-cosine-similarity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>\[\scriptsize{ s_{uv} = \cfrac{\mathbf{u} \cdot \mathbf{v}}{\Vert\mathbf{u}\Vert_2 \Vert\mathbf{v}\Vert_2} }\]<p>OR</p>\[\scriptsize{ s_{uv} = \sum_{i \in \mathcal{T}} \cfrac{e_{ui}e_{vi}}{\Vert\mathbf{u}\Vert_2 \Vert\mathbf{v}\Vert_2} \text{, where } e_{pi} = \begin{cases} 1 &amp; \text{if track $i$ in playlist $p$} \\ 0 &amp; \text{otherwise} \end{cases} }\]<p>여기서 inner product는 id를 one-hot-encoding했을 때의 값이다.<br /> 그러나 knn.py에서는 one-hot-encoding을 사용하지 않고 두 playlist 사이의 교집합의 원소의 개수로 구했다.</p><p>Neighbor 모델에서와는 다르게 여기서는 playlist-playlist similarity를 구한다.</p><h4 id="22-weighting-by-inverse-item-frequency-idf"><span class="mr-2">2.2 Weighting by Inverse Item Frequency (IDF)</span><a href="#22-weighting-by-inverse-item-frequency-idf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>\[\scriptsize{ s_{uv} = \sum_{i \in \mathcal{T}} ((f_i - 1)^\rho + 1)^{-1} \cdot \cfrac{e_{ui}e_{vi}}{\Vert\mathbf{u}\Vert_2 \Vert\mathbf{v}\Vert_2} }\]<p>where $f_i$ denotes the number of playlists containing track i and $rho$ is an hyperparameter.</p><blockquote><p>Two playlists are more likely similar if they include the same low popularity tracks than if they share tracks that a very large number of other lists also include.</p></blockquote><p>IDF를 사용했을 때 사용하지 않을 때보다 훨씬 성능이 좋았다.<br /> 논문에서는 $\rho = 0.4$를 사용해서 같은 $\rho$ 값을 사용하였다.</p><h3 id="3-relevance-r_ui"><span class="mr-2">3. Relevance $r_{ui}$</span><a href="#3-relevance-r_ui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>\[\scriptsize{ r_{ui} = \cfrac{\sum_{v \in N_k(u)} s_{uv} \cdot e_{vi}}{\sum_{v \in N_k(u)} s_{uv}} }\]<p>where $N_k(u)$ is the set of $k$ playlists most similar to $u$.</p><p>target playlist $u$에 대해 모든 playlist $v \in \mathcal{P}$와 similarity $s_{uv}$를 구한 다음 가장 similarity가 큰 상위 $k$로 $N_k(u)$를 정한다.<br /> 그 $N_k(u)$를 사용해서 playlist-track relevance를 구한다.</p><h2 id="modeling"><span class="mr-2">Modeling</span><a href="#modeling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="input--output"><span class="mr-2">Input &amp; Output</span><a href="#input--output" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>논문에서는 Song → Song (Tag → Tag)의 방법이지만 이와 같은 input &amp; output은 성능이 더 좋았던 Neighbor 모델을 사용했다.<br /> <a href="/posts/melon-playlist-continuation-neighbor">Neighbor</a>에서 설명했듯이 Neighbor 모델은 한계가 있어서 이 점을 보완하기 위해 KNN 모델에서는 다음과 같은 예측 방식을 따른다.</p><ul><li>Song → Tag<li>Tag   → Song</ul><p>즉,</p><ul><li>song only인 경우에 대해 <strong>song similarity 기반</strong>으로 유사한 playlist를 찾는다. 유사한 playlist에 있는 <strong>태그</strong>를 자주 등장한 순서대로 정렬한다.<li>tag only인 경우에 대해 <strong>tag similarity 기반</strong>으로 유사한 playlist를 찾는다. 유사한 playlist에 있는 <strong>노래</strong>에 대해 relevance를 구해서 정렬한다.</ul><p>similarity를 구할 때 val.json (test.json)에 있는 song / tag와 Neighbor 모델의 예측 결과로 나온 pred song / tag를 사용한다.<br /> 각 데이터셋에 대해 similarity를 각각 구하고 더하는데, 더할 때의 가중치도 hyperparameter로 설정하였다.</p><ul><li>$\scriptsize{0 \le \text{(weight_val_songs)} \le 1}$ (wvs)<li>weight_pred_songs = 1 - weight_val_songs<li>$\scriptsize{0 \le \text{(weight_val_tags)} \le 1}$ (wvt)<li>weight_pred_tags    = 1 - weight_val_tags</ul><p>추가적으로,</p><ul><li>similarity를 구할 때 normalize 여부를 달리해서도 사용해봤다.<li>모델의 결과가 song 100개 tag 10개 미만이 되는 경우가 있어서 $k$를 늘릴 수 있는 step을 추가했다.</ul><h3 id="optimization"><span class="mr-2">Optimization</span><a href="#optimization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="table-wrapper"><table><thead><tr><th style="text-align: left">hyperparameter<th style="text-align: left">optimal value<tbody><tr><td style="text-align: left">song $k$<td style="text-align: left">500<tr><td style="text-align: left">tag $k$<td style="text-align: left">90<tr><td style="text-align: left">song step<td style="text-align: left">50<tr><td style="text-align: left">tag step<td style="text-align: left">10<tr><td style="text-align: left">sim song<td style="text-align: left">IDF<tr><td style="text-align: left">sim tag<td style="text-align: left">IDF<tr><td style="text-align: left">sim norm<td style="text-align: left">True<tr><td style="text-align: left">wvs<td style="text-align: left">0.9<tr><td style="text-align: left">wvt<td style="text-align: left">0.7</table></div><p>아래에서 사용한 similarity 종류는 IDF, wvs = 0.9, wvt = 0.7이다.</p><h4 id="alpha--07--beta--00--sim-norm--false"><span class="mr-2">$\alpha = 0.7$ &amp; $\beta = 0.0$ &amp; sim norm = False</span><a href="#alpha--07--beta--00--sim-norm--false" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img data-src="/assets/img/melon-playlist-continuation/after_merging_knn_song_score_comparison.png" alt="" data-proofer-ignore> <img data-src="/assets/img/melon-playlist-continuation/after_merging_knn_tag_score_comparison.png" alt="" data-proofer-ignore></p><h4 id="alpha--07--beta--00--sim-norm--true"><span class="mr-2">$\alpha = 0.7$ &amp; $\beta = 0.0$ &amp; sim norm = True</span><a href="#alpha--07--beta--00--sim-norm--true" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img data-src="/assets/img/melon-playlist-continuation/after_merging_knn_song_norm_score_comparison.png" alt="" data-proofer-ignore> <img data-src="/assets/img/melon-playlist-continuation/after_merging_knn_tag_norm_score_comparison.png" alt="" data-proofer-ignore></p><h4 id="alpha--07--beta--00--sim-norm--false--using-threshold"><span class="mr-2">$\alpha = 0.7$ &amp; $\beta = 0.0$ &amp; sim norm = False &amp; using Threshold</span><a href="#alpha--07--beta--00--sim-norm--false--using-threshold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img data-src="/assets/img/melon-playlist-continuation/threshold_knn_song_score_comparison.png" alt="" data-proofer-ignore> <img data-src="/assets/img/melon-playlist-continuation/threshold_knn_tag_score_comparison.png" alt="" data-proofer-ignore></p><h4 id="alpha--065--beta--00--sim-norm--true--using-threshold"><span class="mr-2">$\alpha = 0.65$ &amp; $\beta = 0.0$ &amp; sim norm = True &amp; using Threshold</span><a href="#alpha--065--beta--00--sim-norm--true--using-threshold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img data-src="/assets/img/melon-playlist-continuation/threshold_knn_song_norm_alpha65_score_comparison.png" alt="" data-proofer-ignore> <img data-src="/assets/img/melon-playlist-continuation/threshold_knn_tag_norm_alpha65_score_comparison.png" alt="" data-proofer-ignore></p><h4 id="song-k--100--tag-k--100--song-step--10--tag-step--10"><span class="mr-2">song $k$ = 100 &amp; tag $k$ = 100 &amp; song step = 10 &amp; tag step = 10</span><a href="#song-k--100--tag-k--100--song-step--10--tag-step--10" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img data-src="/assets/img/melon-playlist-continuation/neighbor_songk100_step10_score_comparison.png" alt="" data-proofer-ignore> <img data-src="/assets/img/melon-playlist-continuation/neighbor_tagk100_step10_score_comparison.png" alt="" data-proofer-ignore></p><h2 id="code"><span class="mr-2">Code</span><a href="#code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><details> <summary>KNN.py</summary><div><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="n">data_util</span> <span class="kn">import</span> <span class="n">tag_id_meta</span>


<span class="k">class</span> <span class="nc">KNN</span><span class="p">:</span>
    <span class="sh">'''</span><span class="s">
    K Nearest Neighbor
    </span><span class="sh">'''</span>

    <span class="n">__version__</span> <span class="o">=</span> <span class="sh">"</span><span class="s">KNN-2.0</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">song_k</span><span class="p">,</span> <span class="n">tag_k</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> \
                 <span class="n">song_k_step</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tag_k_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> \
                 <span class="n">weight_val_songs</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight_pred_songs</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> \
                 <span class="n">weight_val_tags</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight_pred_tags</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> \
                 <span class="n">sim_songs</span><span class="o">=</span><span class="sh">"</span><span class="s">idf</span><span class="sh">"</span><span class="p">,</span> <span class="n">sim_tags</span><span class="o">=</span><span class="sh">"</span><span class="s">idf</span><span class="sh">"</span><span class="p">,</span> <span class="n">sim_normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> \
                 <span class="n">train</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">song_meta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">'''</span><span class="s">
        song_k, tag_k, song_k_step, tag_k_step : int
        rho : float; 0.4(default) only for idf
        weights : float
        sim_songs, sim_tags : </span><span class="sh">"</span><span class="s">idf</span><span class="sh">"</span><span class="s">(default), </span><span class="sh">"</span><span class="s">cos</span><span class="sh">"</span><span class="s">
        sim_normalize : boolean;
        </span><span class="sh">'''</span>
        <span class="c1">### data sets
</span>        <span class="n">self</span><span class="p">.</span><span class="n">train_id</span>    <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_songs</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="sh">"</span><span class="s">songs</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_tags</span>  <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">val_id</span>    <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">val_songs</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="sh">"</span><span class="s">songs</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">val_tags</span>  <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">val_updt_date</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="sh">"</span><span class="s">updt_date</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">song_meta_issue_date</span> <span class="o">=</span> <span class="n">song_meta</span><span class="p">[</span><span class="sh">"</span><span class="s">issue_date</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">().</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">pred_songs</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="sh">"</span><span class="s">songs</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pred_tags</span>  <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">freq_songs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">freq_tags</span>  <span class="o">=</span> <span class="bp">None</span>

        <span class="n">self</span><span class="p">.</span><span class="n">song_k</span> <span class="o">=</span> <span class="n">song_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tag_k</span>  <span class="o">=</span> <span class="n">tag_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">song_k_step</span> <span class="o">=</span> <span class="n">song_k_step</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tag_k_step</span>  <span class="o">=</span> <span class="n">tag_k_step</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weight_val_songs</span>  <span class="o">=</span> <span class="n">weight_val_songs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weight_pred_songs</span> <span class="o">=</span> <span class="n">weight_pred_songs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weight_val_tags</span>   <span class="o">=</span> <span class="n">weight_val_tags</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weight_pred_tags</span>  <span class="o">=</span> <span class="n">weight_pred_tags</span>

        <span class="n">self</span><span class="p">.</span><span class="n">sim_songs</span>     <span class="o">=</span> <span class="n">sim_songs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sim_tags</span>      <span class="o">=</span> <span class="n">sim_tags</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sim_normalize</span> <span class="o">=</span> <span class="n">sim_normalize</span>

        <span class="n">self</span><span class="p">.</span><span class="n">__version__</span> <span class="o">=</span> <span class="n">KNN</span><span class="p">.</span><span class="n">__version__</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">id_to_tag</span> <span class="o">=</span> <span class="nf">tag_id_meta</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="n">TOTAL_SONGS</span> <span class="o">=</span> <span class="n">song_meta</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># total number of songs
</span>        <span class="n">TOTAL_TAGS</span>  <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">id_to_tag</span><span class="p">)</span>      <span class="c1"># total number of tags
</span>
        <span class="c1">### transform date format in val
</span>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">val_id</span><span class="p">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">val_updt_date</span><span class="p">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">val_updt_date</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="nf">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">)))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">val_updt_date</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_songs</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idf</span><span class="sh">"</span><span class="p">:</span>

            <span class="n">self</span><span class="p">.</span><span class="n">freq_songs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">TOTAL_SONGS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_songs</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">train_songs</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">freq_songs</span><span class="p">[</span><span class="n">_songs</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_tags</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idf</span><span class="sh">"</span><span class="p">:</span>

            <span class="n">self</span><span class="p">.</span><span class="n">freq_tags</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">TOTAL_TAGS</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_tags</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">train_tags</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">freq_tags</span><span class="p">[</span><span class="n">_tags</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">del</span> <span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">song_meta</span><span class="p">,</span> <span class="n">pred</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">'''</span><span class="s">
        @returns : pandas.DataFrame; columns=[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">songs</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">tags</span><span class="sh">'</span><span class="s">]
        </span><span class="sh">'''</span>

        <span class="n">_range</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">val_id</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_songs</span> <span class="o">=</span> <span class="p">[</span><span class="nf">set</span><span class="p">(</span><span class="n">songs</span><span class="p">)</span> <span class="k">for</span> <span class="n">songs</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">train_songs</span><span class="p">]</span> <span class="c1"># list of set
</span>        <span class="n">all_tags</span> <span class="o">=</span>  <span class="p">[</span><span class="nf">set</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="k">for</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">train_tags</span><span class="p">]</span>    <span class="c1"># list of set
</span>
        <span class="k">for</span> <span class="n">uth</span> <span class="ow">in</span> <span class="n">_range</span><span class="p">:</span>

            <span class="c1"># predict songs by tags
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">val_songs</span><span class="p">[</span><span class="n">uth</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">val_tags</span><span class="p">[</span><span class="n">uth</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">playlist_tags_in_pred</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pred_tags</span><span class="p">[</span><span class="n">uth</span><span class="p">])</span>
                <span class="n">playlist_tags_in_val</span>  <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">val_tags</span><span class="p">[</span><span class="n">uth</span><span class="p">])</span>
                <span class="n">playlist_updt_date</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">val_updt_date</span><span class="p">[</span><span class="n">uth</span><span class="p">]</span>
                <span class="n">simTags_in_pred</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_sim</span><span class="p">(</span><span class="n">playlist_tags_in_pred</span><span class="p">,</span> <span class="n">vplaylist</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_tags</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="sh">'</span><span class="s">tags</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">vplaylist</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">])</span>
                <span class="n">simTags_in_val</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_sim</span><span class="p">(</span><span class="n">playlist_tags_in_val</span> <span class="p">,</span> <span class="n">vplaylist</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_tags</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="sh">'</span><span class="s">tags</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">vplaylist</span> <span class="ow">in</span> <span class="n">all_tags</span><span class="p">])</span>
                <span class="n">simTags</span> <span class="o">=</span> <span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">weight_pred_tags</span> <span class="o">*</span> <span class="n">simTags_in_pred</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">playlist_tags_in_pred</span><span class="p">)))</span> <span class="o">+</span> \
                          <span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">weight_val_tags</span> <span class="o">*</span> <span class="n">simTags_in_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">playlist_tags_in_val</span><span class="p">)))</span>
                <span class="n">songs</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">song_k</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">simTags</span><span class="p">[</span><span class="n">simTags</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">self</span><span class="p">.</span><span class="n">song_k</span><span class="p">)</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">song_k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">song_k</span>

                <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">songs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">simTags</span><span class="p">.</span><span class="nf">argsort</span><span class="p">()[</span><span class="o">-</span><span class="n">song_k</span><span class="p">:]</span>
                    <span class="n">_songs</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">vth</span> <span class="ow">in</span> <span class="n">top</span><span class="p">:</span>
                        <span class="n">_songs</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">train_songs</span><span class="p">[</span><span class="n">vth</span><span class="p">]</span>
                    <span class="n">songs</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">_songs</span><span class="p">)</span>

                    <span class="c1"># check if issue_date of songs is earlier than updt_date of playlist
</span>                    <span class="n">date_checked</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">track_i</span> <span class="ow">in</span> <span class="n">songs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">song_meta_issue_date</span><span class="p">[</span><span class="n">track_i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">playlist_updt_date</span><span class="p">:</span>
                            <span class="n">date_checked</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">track_i</span><span class="p">)</span>
                    <span class="n">songs</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">date_checked</span><span class="p">)</span>

                    <span class="n">song_k</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">song_k_step</span>

                <span class="n">norm</span> <span class="o">=</span> <span class="n">simTags</span><span class="p">[</span><span class="n">top</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.0e+10</span> <span class="c1"># FIXME
</span>
                <span class="n">relevance</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([(</span><span class="n">song</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">([</span><span class="n">simTags</span><span class="p">[</span><span class="n">vth</span><span class="p">]</span> <span class="k">if</span> <span class="n">song</span> <span class="ow">in</span> <span class="n">all_songs</span><span class="p">[</span><span class="n">vth</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">vth</span> <span class="ow">in</span> <span class="n">top</span><span class="p">])</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span> <span class="k">for</span> <span class="n">song</span> <span class="ow">in</span> <span class="n">songs</span><span class="p">])</span>
                <span class="n">relevance</span> <span class="o">=</span> <span class="n">relevance</span><span class="p">[</span><span class="n">relevance</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">argsort</span><span class="p">()][</span><span class="o">-</span><span class="mi">100</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pred_songs</span> <span class="o">=</span> <span class="n">relevance</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">).</span><span class="nf">tolist</span><span class="p">()</span>

                <span class="n">pred</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">val_id</span><span class="p">[</span><span class="n">uth</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">songs</span><span class="sh">"</span> <span class="p">:</span> <span class="n">pred_songs</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pred_tags</span><span class="p">[</span><span class="n">uth</span><span class="p">]</span>
                <span class="p">})</span>

            <span class="c1"># predict tags using songs
</span>            <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">val_songs</span><span class="p">[</span><span class="n">uth</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">val_tags</span><span class="p">[</span><span class="n">uth</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">playlist_songs_in_pred</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pred_songs</span><span class="p">[</span><span class="n">uth</span><span class="p">])</span>
                <span class="n">playlist_songs_in_val</span>  <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">val_songs</span><span class="p">[</span><span class="n">uth</span><span class="p">])</span>
                <span class="n">simSongs_in_pred</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_sim</span><span class="p">(</span><span class="n">playlist_songs_in_pred</span><span class="p">,</span> <span class="n">vplaylist</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_songs</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="sh">'</span><span class="s">songs</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">vplaylist</span> <span class="ow">in</span> <span class="n">all_songs</span><span class="p">])</span>
                <span class="n">simSongs_in_val</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_sim</span><span class="p">(</span><span class="n">playlist_songs_in_val</span> <span class="p">,</span> <span class="n">vplaylist</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_songs</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="sh">'</span><span class="s">songs</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">vplaylist</span> <span class="ow">in</span> <span class="n">all_songs</span><span class="p">])</span>
                <span class="n">simSongs</span> <span class="o">=</span> <span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">weight_pred_songs</span> <span class="o">*</span> <span class="n">simSongs_in_pred</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">playlist_songs_in_pred</span><span class="p">)))</span> <span class="o">+</span> \
                           <span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">weight_val_songs</span> <span class="o">*</span> <span class="n">simSongs_in_val</span><span class="p">)</span>  <span class="o">/</span>  <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">playlist_songs_in_val</span><span class="p">)))</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tag_k</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">simSongs</span><span class="p">[</span><span class="n">simSongs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">self</span><span class="p">.</span><span class="n">tag_k</span><span class="p">)</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">tag_k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tag_k</span>

                <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">simSongs</span><span class="p">.</span><span class="nf">argsort</span><span class="p">()[</span><span class="o">-</span><span class="n">tag_k</span><span class="p">:]</span>
                    <span class="n">_tags</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">vth</span> <span class="ow">in</span> <span class="n">top</span><span class="p">:</span>
                        <span class="n">_tags</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">train_tags</span><span class="p">[</span><span class="n">vth</span><span class="p">]</span>

                    <span class="n">counts</span> <span class="o">=</span> <span class="nc">Counter</span><span class="p">(</span><span class="n">_tags</span><span class="p">).</span><span class="nf">most_common</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">]</span>

                    <span class="n">tag_k</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">tag_k_step</span>

                <span class="n">pred_tags</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>

                <span class="n">pred</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">val_id</span><span class="p">[</span><span class="n">uth</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">songs</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pred_songs</span><span class="p">[</span><span class="n">uth</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">pred_tags</span>
                <span class="p">})</span>

            <span class="c1"># if val.songs[uth] == [] and val.tags[uth] == [] -&gt; pred.songs[uth] == [] and pred.tags[uth] == []
</span>            <span class="c1"># if val.songs[uth] != [] and val.tags[uth] != [] -&gt; pred.songs[uth] != [] and pred.tags[uth] != []
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">id</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">val_id</span><span class="p">[</span><span class="n">uth</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">songs</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pred_songs</span><span class="p">[</span><span class="n">uth</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pred_tags</span><span class="p">[</span><span class="n">uth</span><span class="p">]</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_sim</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="sh">'''</span><span class="s">
        u : set (playlist in train data)
        v : set (playlist in test data)
        sim : string; </span><span class="sh">"</span><span class="s">cos</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">idf</span><span class="sh">"</span><span class="s">
        opt : string; </span><span class="sh">"</span><span class="s">songs</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="s">
        </span><span class="sh">'''</span>

        <span class="k">if</span> <span class="n">sim</span> <span class="o">==</span> <span class="sh">"</span><span class="s">cos</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_normalize</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sim</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idf</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="sh">"</span><span class="s">songs</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">freq_songs</span>
            <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">freq_tags</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="nf">list</span><span class="p">(</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)]</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">self</span><span class="p">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># numpy!
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">sim_normalize</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">freq</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">freq</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
</pre></table></code></div></div></div></details><h2 id="more-ideas"><span class="mr-2">More Ideas</span><a href="#more-ideas" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>IDF 식에서 $((f_i - 1)^\rho + 1)^{-1}$ 부분 변형하기<li>optimal $\rho$ 찾기</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kakao-arena/'>Kakao Arena</a>, <a href='/categories/melon-playlist-continuation/'>Melon Playlist Continuation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kakao-arena/" class="post-tag no-text-decoration" >kakao arena</a> <a href="/tags/melon-playlist-continuation/" class="post-tag no-text-decoration" >melon playlist continuation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fjehunyoo.github.io%2Fposts%2Fmelon-playlist-continuation-knn%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://twitter.com/intent/tweet?text=Melon+Playlist+Continuation+-+Model+2%3A+K+Nearest+Neighbor+-+jehunyoo.github.io&url=https%3A%2F%2Fjehunyoo.github.io%2Fposts%2Fmelon-playlist-continuation-knn%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Melon+Playlist+Continuation+-+Model+2%3A+K+Nearest+Neighbor+-+jehunyoo.github.io&u=https%3A%2F%2Fjehunyoo.github.io%2Fposts%2Fmelon-playlist-continuation-knn%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjehunyoo.github.io%2Fposts%2Fmelon-playlist-continuation-knn%2F&text=Melon+Playlist+Continuation+-+Model+2%3A+K+Nearest+Neighbor+-+jehunyoo.github.io" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/docker-mysql/">Docker 첫 사용기 - MySQL 사용하기</a><li><a href="/posts/waffle-spring-project-architecture/">[Waffle] 스프링 프로젝트 구조 설계하기</a><li><a href="/posts/java-interface-oop/">Java Interface - 객체 지향 프로그래밍의 관점에서</a><li><a href="/posts/lattice-laplacian/">Lattice Laplacian on 2D Boundary</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kakao-arena/">kakao arena</a> <a class="post-tag" href="/tags/melon-playlist-continuation/">melon playlist continuation</a> <a class="post-tag" href="/tags/waffle/">waffle</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/mathematics/">mathematics</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/oop/">oop</a> <a class="post-tag" href="/tags/python/">python</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/melon-playlist-continuation-overview/"><div class="card-body"> <em class="small" data-ts="1595758800" data-df="ll" > Jul 26, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Melon Playlist Continuation - Overview</h3><div class="text-muted small"><p> Project Repository Goal 주어진 playlist에 대해 songs 100개, tags 10개를 순서에 맞게 예측해야 한다. Predict additional 100 songs and 10 tags in orderly-correct way for all given playlists. Data 대회에서 주어진 데이터는 크게 두가...</p></div></div></a></div><div class="card"> <a href="/posts/melon-playlist-continuation-neighbor/"><div class="card-body"> <em class="small" data-ts="1595758920" data-df="ll" > Jul 26, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Melon Playlist Continuation - Model 1: Neighbor-based</h3><div class="text-muted small"><p> Reference [Paper] [Code] Automatic Music Playlist Continuation via Neighbor-based Collaborative Filtering and Discriminative ReweightingReranking (RecSys’18 Challenge) 위의 논문을 바탕으로 Neighbor 모델을 만들...</p></div></div></a></div><div class="card"> <a href="/posts/docker-mysql/"><div class="card-body"> <em class="small" data-ts="1705744800" data-df="ll" > Jan 20, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker 첫 사용기 - MySQL 사용하기</h3><div class="text-muted small"><p> Introduction 최근에 MySQL을 프로젝트에서 사용하기로 결정하기도 했고, MySQL에 대해 깊이 있게 공부하기 위해서 맥북에 설치가 필요했다. 그냥 로컬에 설치하는건 어렵지 않지만 MariaDB도 설치해야 하는 경우에 애를 먹었던 기억이 있어서 다른 방법으로 설치를 하고 싶었다. (정확하지는 않지만) 두 데이터베이스가 설치 경로를 공유...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/melon-playlist-continuation-neighbor/" class="btn btn-outline-primary" prompt="Older"><p>Melon Playlist Continuation - Model 1: Neighbor-based</p></a> <a href="/posts/c-cheatsheet/" class="btn btn-outline-primary" prompt="Newer"><p>C CheatSheet</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://www.linkedin.com/in/jehunyoo">Jehun Yoo</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kakao-arena/">kakao arena</a> <a class="post-tag" href="/tags/melon-playlist-continuation/">melon playlist continuation</a> <a class="post-tag" href="/tags/waffle/">waffle</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/mathematics/">mathematics</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/oop/">oop</a> <a class="post-tag" href="/tags/python/">python</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
